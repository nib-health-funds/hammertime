env:
  AWS_REGION: ap-southeast-2
  DEFAULT_AWS_REGION: ap-southeast-2

steps:
  - name: ':nodejs: Test & Deploy'
    command: '
      docker run -v $PWD:/tmp -w /tmp node:4 /bin/bash -c "
        set -eo pipefail &&
        npm install -q &&
        npm test &&
        npm deploy
      "
    '
    agents:
      os: 'linux'
    concurrency: 1
    concurrency_group: "${BUILDKITE_PIPELINE_SLUG}/deploy-${BUILDKITE_BRANCH}-to-kaos"
