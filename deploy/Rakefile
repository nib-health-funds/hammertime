require 'cloudformer'
require_relative 'assume_role.rb'
require 'aws-sdk'

AssumeRole.new.set_credentials!

environment = ENV['ENVIRONMENT']
version = "1.#{ENV['BUILDKITE_BUILD_NUMBER']}"

Cloudformer::Tasks.new("hammertime") do |t|
  t.template = "hammertime-cf.json"
  t.tags = []
  t.parameters = { "LambdaVersion" => version }
  t.capabilities = %w(CAPABILITY_IAM)
end

task :upload do
  sh 'rm -f *.zip && buildkite-agent artifact download "*.zip" ./' # && aws s3 cp stop-hammertime-*.zip s3://nib-kaos-lambdas/ && aws s3 cp start-hammertime-*.zip s3://nib-kaos-lambdas/'
  artifact = Dir.glob("*.zip").first
  s3     = AWS::S3::Client.new
  File.open(artifact) do |file|
    mime_type = MIME::Types.type_for(s3_key).first
    content_type = mime_type.nil? ? 'text/plain' : mime_type.content_type # default to text/plain if no file extension/unknown file extension
    s3.put_object(bucket: 'nib-kaos-lambdas', key: artifact, body: file, acl: 'public-read', content_type: content_type)
  end
end
